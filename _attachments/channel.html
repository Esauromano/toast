<!DOCTYPE html>
<html>
  <head>
    <title>Welcome to Toast</title>
    <link rel="stylesheet" href="style/main.css" type="text/css">
    <link media="only screen and (max-device-width: 480px)" 
        href="style/iphone.css" type="text/css" rel="stylesheet" />      
  </head>
  <body>
    <h1>Toast</h1>
    <div id="sidebar">
      <p>Go to the index <a href="index.html">to make new channels or find others.</a> Download the <a href="http://github.com/jchris/toast">Toast source code at Github.</a></p>
      <p><strong>Toast</strong> is deployed on a standard instance of <a href="http://couchdb.org">CouchDB</a>, running on an old Mac Mini in an overheated colo closet. You are encouraged to install CouchDB (0.10.0) on your computer and run your own Toast instances. You can even use replication to sync with other people's chats.</p>
    </div>
    <div id="chat">
      <form id="new_message" action="#">
        <p><label for="message">Message</label> <input type="text" name="message" value="" id="message" size=90 autocomplete="off">
        </p>
        <p><label for="author-name">Name</label>
          <input type="text" name="author-name" value="" id="author-name">
          <label for="author-email">Email (<em>for <a href="http://gravatar.com">Gravatar</a></em>)</label>
          <input type="text" name="author-email" value="" id="author-email">
          <input type="submit" value="Go &rarr;">
        </p>
      </form>
      <ul id="messages"></ul>
    </div>
  </body>
  <script src="/_utils/script/json2.js"></script>
  <script src="/_utils/script/jquery.js"></script>
  <script src="/_utils/script/jquery.couch.js"></script>
  <script src="/_utils/script/jquery.cookies.js"></script>
  <script src="vendor/couchapp/jquery.couchapp.js"></script>
  <script type="text/javascript" charset="utf-8">
  var c_xhr;
    $.CouchApp(function(app) {
      function linkify(body, term) {
        return body.replace(/https?\:\/\/\S+/g,function(a) {
          return '<a target="_blank" href="'+a+'">'+a+'</a>';
        }).replace(/\@([\w\-]+)/g,function(user,name) {
          return '<a target="_blank" href="http://twitter.com/'+name+'">'+user+'</a>';
        }).replace(/\#([\w\-]+)/g,function(word,term) {
          return '<a target="_blank" href="http://search.twitter.com/search?q='+encodeURIComponent(term)+'">'+word+'</a>';
        });
      };
      
      function escapeHTML(st) {                                       
              return(                                                                 
                  st.replace(/&/g,'&amp;').                                         
                      replace(/>/g,'&gt;').                                           
                      replace(/</g,'&lt;').                                           
                      replace(/"/g,'&quot;')                                         
              );                                                                     
          };
      
      var cname = unescape(document.location.hash.replace(/^#/,''));
      $('h1').text('Toast - ' + cname);
      function refreshView() {
        app.view("channels",{
          reduce: false, 
          startkey : [cname,{}],
          endkey : [cname],
          descending: true,
          limit : 25,
          success: function(json) {
          $("#messages").html(json.rows.map(function(row) {
            var m = row.value;
            return '<li>'
              + '<img class="gravatar" src="http://www.gravatar.com/avatar/'+row.value.author.gravatar+'.jpg?s=40&d=identicon"/><span class="say"><strong>'
              + escapeHTML(m.author.name)
              + "</strong>: "
              + linkify(escapeHTML(m.body))
              + '</span><br class="clear"/></li>';
          }).join(''));
        }});
      };
      $("#author-name").val($.cookies.get("name"));
      $("#author-email").val($.cookies.get("email"));
      $("#new_message").submit(function() {
        var name, email;
        name = $("#author-name").val();
        email = $("#author-email").val();
        $.cookies.set("name", name);
        $.cookies.set("email", email);
        
        var message = {
          author: {
            name : $("#author-name").val(),
            email :$("#author-email").val(),
          },
          body : $("#message").val()
        };
        app.db.saveDoc({channel:cname,message:message});
        $("#message").val('')
        return false;
      });
      // this is where we hang on the continuous _changes api
      // get the raw xhr
      refreshView();
      app.db.info({success: function(json) {
        c_xhr = jQuery.ajaxSettings.xhr();
        c_xhr.open("GET", app.db.uri+"_changes?continuous=true&since="+json.update_seq, true);
        c_xhr.send("");
        c_xhr.onreadystatechange = function() {
          refreshView();
        };        
      }})
      


    });
  </script>
</html>
