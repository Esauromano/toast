<!DOCTYPE html>
<html>
  <head>
    <title><%= author %> : on toast</title>
    <link rel="stylesheet" href="../../screen.css" type="text/css">
  </head>
  <body>
    <h1>Toast</h1>
    <p>Go to the index <a href="index.html">to make new channels or browse to others.</a> <a href="http://github.com/jchris/toast">Download the Toast source code at Github.</a></p>
    
    <ul id="messages"></ul>
    <li>
      <img class="gravatar" src="http://www.gravatar.com/avatar/<%= gravatar %>.jpg?s=40&d=identicon"/>
      <span class="say"><strong><%= name %></strong>: <%= body %>))
      </span><br class="clear"/>
    </li>
    
  </body>
  <script src="/_utils/script/json2.js"></script>
  <script src="/_utils/script/jquery.js?1.2.6"></script>
  <script src="/_utils/script/jquery.couch.js?0.8.0"></script>
  <script src="<%= assets %>/vendor/couchapp/jquery.couchapp.js"></script>
  <script src="<%= assets %>/blog.js"></script>
  <script type="text/javascript" charset="utf-8">
  $.CouchApp(function(app) {
      var docid = document.location.pathname.split('/').pop();
      var B = new Blog(app);
      
      $('.date').each(function() {
        $(this).text(app.prettyDate(this.innerHTML));
      });
      
      function displayComments() {
        app.design.view("comments", {
          startkey: [docid],
          endkey: [docid, {}],
          reduce : false,
          success: function(json) {
            var ul = $("#comments ul");
            for (var i=0; i < json.rows.length; i++) {
              var c = json.rows[i].value;
              ul.append(B.commentListing(c));
            }
            $('#comments').fadeIn(2000);      
          }
        });
      };
      
      displayComments();
      
      var commentForm = app.docForm("form#new-comment", {
        fields : [
          "commenter-name", 
          "commenter-email", 
          "commenter-url", 
          "comment"
        ],
        template : {
          type : "comment",
          post_id : docid,
          format : "markdown"
        },
        beforeSave : function(doc) {
          doc.html = B.formatBody(doc.comment, doc.format);
          doc.created_at = new Date();
        },
        success : function(resp, doc) {
          $("#new-comment").html('<h2>Success! Your comment has posted.</h2>');
          $("#comments ul").append(B.commentListing(doc));
          $("#comments ul li:last").hide().fadeIn(2000);
        }
      });
      
      $("#preview").click(function() {
        var doc = commentForm.localDoc();
        var html = B.formatBody(doc.comment, doc.format);
        $('#comment-preview').html(html);
      });
    });
  </script>
  <script src="<%= assets %>/showdown.js"></script>
</html>